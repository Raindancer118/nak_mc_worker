# NAK Minecraft Speedrun API Documentation

Base URL: `https://mc-worker.raindancer118.de` (or wherever deployed)

## Authentication
All API requests must include the `X-API-Key` header.
- **Header**: `X-API-Key: <API_SECRET>`
- **Response if missing/invalid**: `401 Unauthorized`

## Endpoints

### 0. Initialize Database (Admin)
Call this once to create the database tables.

- **URL**: `/api/admin/init-db`
- **Method**: `POST`
- **Body**: None
- **Response**:
```json
{ "success": true, "message": "Database initialized" }
```

### 1. Public Statistics
Get global statistics and server status. No authentication required.

- **URL**: `/public-stats` (JSON API)
- **URL**: `/status` (HTML Status Page)
- **Method**: `GET`
- **Body**: None
- **Response**:
```json
{
  "server_status": "ONLINE",
  "totals": { "total_runs": 10, "finished_runs": 5 },
  "leaderboard": [ ... ],
  "recent_runs": [ ... ],
  "active_run": null
}
```

### 2. Reset World & Restart Server
Call this to reset the server for a new run. This stops the server, deletes the world, and starts it again.

- **URL**: `/api/run/reset`
- **Method**: `POST`
- **Body**: None
- **Response**:
```json
{ "success": true, "message": "Server reset initiated in background" }
```
*Returns `202 Accepted` immediately. The reset process continues in the background.*

### 3. Initialize Run
Call this when the speedrun is set up (team/solo selected).

- **URL**: `/api/run/init`
- **Method**: `POST`
- **Body**:
```json
{
  "run_id": "uuid-v4-string",
  "type": "SOLO", // or "TEAM"
  "seed": "123456789",
  "players": [
    { "name": "Player1", "role": "RUNNER" },
    { "name": "Player2", "role": "SPECTATOR" }
  ]
}
```
- **Response**:
```json
{ "success": true, "message": "Run initialized" }
```

### 2. Update Run State
Call this for state changes.
- **START**: When the first player moves.
- **PAUSE**: When the runner (or all team members) leaves.
- **RESUME**: When the runner (or a team member) rejoins and moves.
- **ABORT**: If the run is cancelled manually.

- **URL**: `/api/run/update-state`
- **Method**: `POST`
- **Body**:
```json
{
  "run_id": "uuid-v4-string",
  "action": "START" // "PAUSE", "RESUME", "ABORT"
}
```
- **Response**:
```json
{ "success": true, "status": "RUNNING" }
```

### 3. Log Cheat Suspicion
Call this when the anti-cheat detects something.

- **URL**: `/api/run/cheat`
- **Method**: `POST`
- **Body**:
```json
{
  "run_id": "uuid-v4-string",
  "player_name": "Cheater123",
  "details": "Fly hack detected"
}
```
- **Response**:
```json
{ "success": true }
```

### 4. Finish Run
Call this when the Ender Dragon is defeated. This will calculate the final time and mark the seed as solved.

- **URL**: `/api/run/finish`
- **Method**: `POST`
- **Body**:
```json
{
  "run_id": "uuid-v4-string"
}
```
- **Response**:
```json
{
  "success": true,
  "stats": {
    "run_id": "...",
    "type": "SOLO",
    "seed": "...",
    "duration_ms": 3605000,
    "duration_formatted": "1h 0m 5s",
    "players": ["Player1"],
    "cheat_incidents": 0,
    "solved_at": 1700000000000
  }
}
```

### 5. Check Seed
Optional: Check if a seed has already been solved before generating a world.

- **URL**: `/api/seed/:seed/check`
- **Method**: `GET`
- **Response**:
```json
{ "solved": true } // or false
```

## Notes
- The `run_id` should be generated by the plugin (e.g., a UUID) and persisted for the duration of the session.
- Time is calculated on the server based on the `timestamp` of the `update-state` calls. Ensure `START` and `END`/`PAUSE` calls are paired correctly.
